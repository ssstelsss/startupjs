import { BASE_URL } from '@env'
import { useState, useEffect } from 'react'
import { useSession } from 'startupjs'
import { Button, Row, Div, Br, TextInput } from '@startupjs/ui'
import { sendNotification } from '@startupjs/push-notifications'

# Push Notifications

!IMPORTANT! The package only works on ios and android platforms!

## Dependencies

```js
@react-native-community/push-notification-ios >= 1.8.0
react-native-push-notification >= 7.2.3
```

## Installation

```js
yarn add @startupjs/push-notifications @react-native-community/push-notification-ios react-native-push-notification
```


## Connecting certificates

### Create p8 certificate

In order to send push notifications to ios devices, you need to create certificates.

Select `Certificates, Identifiers & Profiles` and go to `Keys`. Click the + circle button to create a new key.

![alpha](/img/docs/push-notifications/pushs2.png "Certificates, Identifiers & Profiles")

Give it a name and enable the `Apple Push Notifications service (APNs)`. Choose `Continue` and on the next screen choose `Register`.

![alpha](/img/docs/push-notifications/pushs3.png "Apple Push Notifications service (APNs)")

It is important to record the following three elements from this page:

- Select `Download` to save the `p8` file locally. You will need to upload this to `Firebase`. You will not be able to download this certificate by leaving this page.
- Copy and save the `Key ID`.
- Copy and save your membership ID. It is located next to your name in the upper right corner of the Membership Center or in the `Membership Details` section.

![alpha](/img/docs/push-notifications/pushs4.png "Apple Push Notifications service (APNs)")

### Setting up a Firebase project

You need to connect the `p8` certificate to your application in `Firebase`. In your `Firebase` project, select the gear next to `Project Overview` and select `Project settings`:

![alpha](/img/docs/push-notifications/pushs5.png "Apple Push Notifications service (APNs)")

Then set up your iOS app in the `General` section of your project settings. Do all the operations indicated:

![alpha](/img/docs/push-notifications/pushs6.png "Apple Push Notifications service (APNs)")

Then upload your `p8` certificate by going to `Cloud Messaging` in the `Firebase` project settings. In the `APNs Authentication Key` section, select `Upload`.

![alpha](/img/docs/push-notifications/pushs7.png "Apple Push Notifications service (APNs)")

Enter the details that you saved in the step of creating the `p8` certificate.

## Using

### Connection

### server

```js
import { initFirebaseApp, initPushNotifications } from '@startupjs/push-notifications/server'
const serviceAccountPath = path.join(process.cwd(), 'path/to/serviceAccountKey.json')
...
init({ orm })
initFirebaseApp(serviceAccountPath)

...
startupjsServer({
...
}, (ee, options) => {
  ...
  initPushNotifications(ee)
  ...
}

```
You can generate a `serviceAccount` in the `Firebase` [console](https://console.firebase.google.com/project/) of your application. Open the `Service accounts` tab and click `Generate new private key`.

![alpha](/img/docs/push-notifications/pushs1.png "firebase admin")

### client

Call `initPushNotifications` (if you need to create an additional channel for the android, then add the `initAndroidChannel` function) in the place where you need to initialize the device token of the current user (devices are written based on the userId from the current session). It makes sense to perform initialization only for an authorized user. But, if necessary, initialization is allowed for each visitor, for this functions can be called directly in the `useGlobalInit` callback of `App`.

```js
App(
  ...
  useGlobalInit=() => {
    initPushNotifications()
    // Creation of an additional channel, the 'default' channel is created when initPushNotifications are executed
    initAndroidChannel({
        channelId: 'my-test-channel',
        channelName: 'My channel'
    })
    return true
  }
)
```

## API

### server API

- `initPushNotifications (ee)`

- `initFirebaseApp(serviceAccount)` - initialization of the `Firebase` application. How to create a `serviceAccount` see [above](/docs/libraries/push-notofications#server).
  - `serviceAccountPath` - string, absolute path to `serviceAccount`.

### client API

- `initAndroidChannel (options, callback)` - function of registering a new channel of push messages for Android. Push notifications on `Android` must be sent to the channel, otherwise the message will not be delivered. Several different channels can be created.
  - `options [Object]` - object of options for creating a channel, a complete list of options can be found in the [documentation](https://github.com/zo0r/react-native-push-notification#channel-management-android). Required parameters:
    - `channelId [String]` - string, channel unique identifier
    - `channelName [String]` - string, channel name
  - `callback [Function]` - callback, takes an argument `created`, which indicates whether the channel has already been created, `false` means that the channel has already been created

- `initPushNotifications (options)` - function of initializing push notifications. Also initializes the channel id `default` for android.
  - `options [Object]` - object of options for initializing push notifications. A complete list of options can be found in the [documentation](https://github.com/zo0r/react-native-push-notification#usage). !!IMPORTANT!! It is highly discouraged to override the `onRegister` and `onNotification` fields as this may break the package behavior.

- `sendNotification(userIds, options)` - function for sending notifications. - `options [Object]`:
    - `title [String]` - header string.
    - `body [String] (required)` - content string.
    - `androidChannelId [String]` - string with the channel name for android.
    - `filters [Object]` - filters object. The following fields are supported:
      - `platforms [Array]` - an array of platforms to send notification to. If not specified, the message will be sent to all registered devices.


### Example

```jsx example
const [title, setTitle] = useState('')
const [body, setBody] = useState('')
const [userId] = useSession('userId')

function sendCustomNotification () {
  sendNotification([userId], {
    title,
    body,
    androidChannelId: 'my-test-channel'
  })
  setTitle('')
  setBody('')
}

return (
  <Div>
    <TextInput
      value={title}
      placeholder='title'
      onChangeText={setTitle}
    />
    <Br/>
    <TextInput
      value={body}
      placeholder='content'
      onChangeText={setBody}
    />
    <Br/>
    
    <Button onPress={sendCustomNotification}>
      Send Test Push
    </Button>
  </Div>
)
```
