import { useState } from 'react'
import { Div, Button, Span, Br } from '@startupjs/ui'
import { useProviders, ProvidersList2fa } from '@startupjs/2fa-manager'
import { CheckToken } from '@startupjs/2fa'

# 2fa-manager

Компонент для использования различных способов двухфакторной авторизации.

## Установка

```js
  yarn add @startupjs/2fa-manager
```

## Подключение к startupjs

### server

В `server/index.js` добавить следующие строки:

```js
  import { initTwoFAManager } from '@startupjs/2fa-manager/server'
```

В `startupjsServer` функцию добавить:

```js
  initTwoFAManager(ee, {
    providers: [YOUR_PROVIDER1, YOUR_PROVIDER2]
  })
```

### Создание своих провайдеров

Вы можете создавать собственные провайдеры с помощью класса `Provider` из `@startupjs/2fa-manager/Provider`.

Класс `Provider(name, send, check)` где:

- `name` - строка, имя провайдера.
- `send()` - функция отправки сообщения с кодом.
- `check(code)` - функция проверки валидности кода.
  - `code` - код, который необходимо проверить.

## Пример

```js
import { Provider } from '@startupjs/2fa-manager/Provider'

function init (ee, options) {
  return null
}

function send () {
  console.log('test code')
}

function check (token) {
  if (token === 'test code') {
    console.log('Right code')
  } else {
    console.log('Wrong code')
  }
}

export default new Provider('testProvider', init, send, check)
```

Теперь этот `Provider` можно зарегистрировать в `initTwoFaManager` и использовать по имени `testProvider`.

## API

### server

### `initTwoFaManager(ee, options)`

- `ee` - eventEmitter сервера.
- `options` - объект опций. Содержит список провайдеров:
  - `providers` - массив провайдеров.

### TwoFAManager

Класс синглтон, который содержит следующие методы:

- `send(model, session, providerName)` - вызывет метод `send` провайдера `providerName`.
- `check(model, session, token, providerName)` - вызывет метод `check` провайдера `providerName`.
- `getProviders()` - возвращает массив имен, зарегистрированных провайдеров.

### client

### ProvidersList2fa(providers, chooseProvider)

Компонент для отображения списка зарегистрированных провайдеров. Принимает следующие пропсы:

- `providers` - массив имен провайдеров
- `chooseProvider` - функция, возвращает имя выбранного провайдера

```js
import { useProviders } from '@startupjs/2fa-manager'
```

```jsx example
const providers = useProviders()
const [currentProvider, setCurrentProvider] = useState('')
return pug`
  ProvidersList2fa(
    providers=providers
    chooseProvider=setCurrentProvider
  )
  Br
  if currentProvider
    Span= 'You chose the ' + currentProvider
`
```

## Пример

```js
import { CheckToken } from '@startupjs/2fa'
```

```jsx example
const providers = useProviders()
const [currentProvider, setCurrentProvider] = useState('')

return pug`
  Div
    if !currentProvider
      ProvidersList2fa(providers=providers chooseProvider=setCurrentProvider)
    else
      if currentProvider === 'google-authenticator'
        CheckToken(
          onSuccess=() => console.log('Code is right')
          onDismiss=() => console.log('Code is wrong')
        )
`
```